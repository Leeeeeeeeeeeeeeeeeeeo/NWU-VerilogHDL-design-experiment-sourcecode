// Testbench信号声明（完整版）
`timescale 1ns/1ps
module key_debounce_led_tb;

// 1. 信号声明（必须包含所有用到的信号）
reg            clk;        
reg            rst_n;      
reg      [2:0] key_in;     
wire     [2:0] led_out;    
wire     [2:0] key_state;  // 消抖后按键状态（与设计模块端口对应）

// 2. 模块实例化（端口连接格式正确，与修正后的button.v端口完全匹配）
key_debounce_led u_key_debounce_led(
    .clk        (clk),        // 时钟端口：激励信号clk连接到设计模块clk
    .rst_n      (rst_n),      // 复位端口：激励信号rst_n连接到设计模块rst_n
    .key_in     (key_in),     // 按键输入：激励信号key_in连接到设计模块key_in
    .led_out    (led_out),    // LED输出：设计模块led_out连接到观察信号led_out
    .key_state  (key_state)   // 消抖状态：设计模块key_state连接到观察信号key_state
);

// 3. 生成时钟激励（100MHz，周期10ns：5ns高电平，5ns低电平）
always #5 clk = ~clk;

// 4. 生成复位与按键激励（核心：模拟抖动与稳定状态）
initial begin
    // 初始化所有信号
    clk     = 1'b0;
    rst_n   = 1'b0;  // 初始复位拉低
    key_in  = 3'b111; // 按键默认释放（高电平，因开发板上拉电阻）
    #20;              // 复位保持20ns（2个时钟周期）
    rst_n   = 1'b1;  // 释放复位，系统进入正常状态
    #1000000;         // 等待1ms，确保系统稳定（时间单位：1ns，1ms=1e6ns）

    // --------------------------
    // 场景1：模拟BTNU（key_in[2]）按下+抖动+稳定+释放+抖动
    // --------------------------
    key_in[2] = 1'b0; #1000000; // 低电平1ms（抖动）
    key_in[2] = 1'b1; #1000000; // 高电平1ms（抖动）
    key_in[2] = 1'b0; #1000000; // 低电平1ms（抖动）
    key_in[2] = 1'b1; #1000000; // 高电平1ms（抖动）
    key_in[2] = 1'b0; #1000000; // 低电平1ms（抖动结束，稳定按下）
    #40000000;                  // 稳定按下40ms
    // 释放抖动
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000; // 稳定释放
    #20000000;                  // 间隔20ms

    // --------------------------
    // 场景2：模拟BTNL（key_in[1]）与BTND（key_in[0]）先后操作
    // --------------------------
    // BTNL按下（带抖动）
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    #40000000;                  // 稳定40ms
    // BTNL释放（带抖动）
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    #20000000;                  // 间隔20ms

    // BTND按下（带抖动）
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    #40000000;                  // 稳定40ms
    // BTND释放（带抖动）
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    #20000000;                  // 间隔20ms

    // --------------------------
    // 场景3：模拟快速按键（BTNU稳定时间40ms）
    // --------------------------
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    #40000000;                  // 稳定40ms（快速按下最小稳定时间）
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;

    // 仿真结束（总时长≈300ms）
    #50000000;
    $stop; // 暂停仿真，便于观察波形
end

// 打印关键信号变化（日志查看功能）
initial begin
    $monitor("Time = %0t ns | rst_n = %b | key_in = %b | key_state = %b | led_out = %b",
             $time, rst_n, key_in, key_state, led_out);
end

endmodule