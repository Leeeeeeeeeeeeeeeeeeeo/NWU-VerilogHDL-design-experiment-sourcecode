`timescale 1ns/1ps
module key_debounce_led_tb;

// 信号声明（删除冗余key_state，仅保留核心激励与观察信号）
reg            clk;        
reg            rst_n;      
reg      [2:0] key_in;     
wire     [2:0] led_out;    

// 模块实例化（与最终设计程序端口完全匹配，无多余端口）
key_debounce_led u_key_debounce_led(
    .clk        (clk),        
    .rst_n      (rst_n),      
    .key_in     (key_in),     
    .led_out    (led_out)     
);

// 生成100MHz时钟激励（周期10ns，与设计一致，无需修改）
always #5 clk = ~clk;

// 生成复位与按键激励（核心修改：适配高电平有效特性）
initial begin
    // 初始化信号（匹配硬件：未按=0，复位未按=0）
    clk     = 1'b0;
    rst_n   = 1'b1;  // 初始模拟“按下复位键”（高电平有效）
    key_in  = 3'b000; // 按键默认未按（低电平，匹配硬件下拉电阻）
    #20;              // 复位保持20ns（2个时钟周期，确保初始化完成）
    rst_n   = 1'b0;  // 释放复位键（未按=0，复位无效）
    #1000000;         // 等待1ms，确保系统稳定（1ms=1e6ns）

    // --------------------------
    // 场景1：模拟BTNU（key_in[2]）按下+抖动+稳定+释放+抖动
    // 激励逻辑：未按=0，按下=1（高电平有效）
    // --------------------------
    key_in[2] = 1'b1; #1000000; // 高电平1ms（抖动）
    key_in[2] = 1'b0; #1000000; // 低电平1ms（抖动）
    key_in[2] = 1'b1; #1000000; // 高电平1ms（抖动）
    key_in[2] = 1'b0; #1000000; // 低电平1ms（抖动）
    key_in[2] = 1'b1; #1000000; // 高电平1ms（抖动结束，稳定按下）
    #40000000;                  // 稳定按下40ms（超过20ms消抖阈值）
    // 释放抖动
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000; // 稳定释放（未按=0）
    #20000000;                  // 间隔20ms

    // --------------------------
    // 场景2：模拟BTNL（key_in[1]）与BTND（key_in[0]）先后操作
    // 验证多按键独立性
    // --------------------------
    // BTNL按下（带抖动）
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    #40000000;                  // 稳定40ms
    // BTNL释放（带抖动）
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    key_in[1] = 1'b1; #1000000;
    key_in[1] = 1'b0; #1000000;
    #20000000;                  // 间隔20ms

    // BTND按下（带抖动）
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    #40000000;                  // 稳定40ms
    // BTND释放（带抖动）
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    key_in[0] = 1'b1; #1000000;
    key_in[0] = 1'b0; #1000000;
    #20000000;                  // 间隔20ms

    // --------------------------
    // 场景3：模拟快速按键（BTNU再次操作）
    // 验证快速操作时消抖有效性
    // --------------------------
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    #40000000;                  // 稳定40ms
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;
    key_in[2] = 1'b1; #1000000;
    key_in[2] = 1'b0; #1000000;

    // 仿真结束（总时长≈300ms，便于观察波形）
    #50000000;
    $stop; 
end

// 打印关键信号变化（仅显示核心激励与观察信号，日志简洁）
initial begin
    $monitor("Time = %0t ns | rst_n = %b | key_in = %b | led_out = %b",
             $time, rst_n, key_in, led_out);
end

endmodule